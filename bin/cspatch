#!/bin/bash
# This is config spec patcher hack wrapper.
# This is an untested hack that may kill your pet.
# It will use the output of "clearcase ci" to patch a config spec.
#
function warn() { echo "$@" >&2 ; }
function die() { warn "FATAL: $@" ; exit 2 ; }

function usage()
{
  # ~/tmp/out.txt could be generated by:
  # cp message ~/tmp/out.txt
  # ct ci -c `cat message` | tee -a ~/tmp/out.txt
  echo "usage: cspatch <checkin_log_file> <start_tag_regex> <csfile>" >&2
  echo " e.g.: cspatch ~/tmp/out.txt \"BEGIN wcg-load ASV\" latest.cs" >&2
  exit 2
}

log=$1 || usage
shift
regex=$1 || usage
shift
cs=$1 || usage
shift
[ "$1" ] && { warn "Too many arguments." ; usage ; }

pl="${0%%.sh}.pl" # cut .sh, append .pl
test -e "$pl" || die "Failed to find implementation script $pl."
exec perl -npi "$pl" "$log" "$regex" "$cs"
