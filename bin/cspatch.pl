#!/usr/bin/perl
# This is config spec patcher hack.
# This is an untested hack that may kill your pet.
# It will use the output of "clearcase ci" to patch a config spec.

our $checkinlog;
our $startlineregex;
our $replacements;
our $patch;

sub usage()
{
  # ~/tmp/out.txt could be generated by:
  # cp message ~/tmp/out.txt
  # ct ci -c `cat message` | tee -a ~/tmp/out.txt
  die "usage: cspatch <checkin_log_file> <start_tag_regex>\n"
    . " e.g.: cspatch ~/tmp/out.txt \"BEGIN wcg-load ASV\"\n"
    . " e.g.: perl -npi ./cspatch.pl ~/tmp/sync_out.txt \"BEGIN wcg-load ASV\" /vobs/path/my.cs\n";
}

BEGIN
{
  $checkinlog = shift @ARGV || usage;
  $startlineregex = shift @ARGV || usage;
  {
    my @loglines = ();
    open LOG, "$checkinlog" or die "Failed to open log $checkinlog: $!\n";
    push @loglines, ""; # start with a blank line.
    while (my $logline = <LOG>) {
      chomp $logline;
      if ($logline =~ m/^Checked in "(\S*)" version "(\S*)"\.$/) {
         my ($element, $version) = ($1, $2);
         $element =~ s|/view/[^/]+/|/|; # cut optional "/view/sdettmer_latest/" prefix
         # Whitespace-free without quoting.
         $logline = sprintf "%-184s %s", "    element $element", $version;
      } elsif ($logline =~ m/^Checked in (".*") version (".*")\.$/) {
         # whitespace in path -> quoting.
         $logline = sprintf "%-184s %s", "    element $1", $2;
      } elsif ($logline =~ m/^cleartool: Warning: Version checked in is not selected by view\.$/) {
          # ignore
          $logline = undef;
      } else {
         # comment
         $logline = "    # $logline";
      }
      push @loglines, $logline unless (!defined($logline));
    }
    $patch = join("\n", @loglines);
    close LOG, "$checkinlog" or die "Failed to close log $checkinlog: $!\n";
  }
  warn "log \"$checkinlog\", regex \"$startlineregex\", ARGV: @ARGV\n";
}

if (s/($startlineregex)/\1\n$patch/) {
  $replacements++;
  # warn "xxx $replacements replacements\n";
}

END
{
  # warn "log \"$checkinlog\", regex \"$startlineregex\", ARGV: @ARGV\n";
  warn "$replacements replacements\n";
  if ($replacements == 0) {
      die "No replacements performed!\n";
  }
}
